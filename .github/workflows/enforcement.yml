name: Enforcement Checks

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual trigger

jobs:
  core-boundary-lint:
    name: Core Boundary Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Run core boundary lint
        run: |
          python scripts/lint_core_boundary.py
        continue-on-error: false

  verifier-gate-checks:
    name: Verifier + Gate Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests
        run: |
          pytest tests/ -v --tb=short
      
      - name: Run linter
        run: |
          ruff check src/ tests/
      
      - name: Type checking
        run: |
          mypy src/ybis --ignore-missing-imports
      
      - name: Security scan
        run: |
          bandit -r src/ybis -f json -o bandit-report.json

  adapter-registry-check:
    name: Adapter Registry Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Validate adapter registry
        run: |
          python -c "
          import sys
          from pathlib import Path
          sys.path.insert(0, str(Path.cwd()))
          
          from src.ybis.adapters.registry import get_registry
          from src.ybis.services.adapter_bootstrap import bootstrap_adapters
          from src.ybis.services.adapter_catalog import get_catalog
          
          # Bootstrap adapters
          bootstrap_adapters()
          registry = get_registry()
          
          # Check that registry is initialized
          adapters = registry.list_adapters()
          print(f'[INFO] Adapter registry initialized: {len(adapters)} adapters registered')
          
          # Validate that adapters can be retrieved
          if len(adapters) == 0:
              print('[WARNING] No adapters registered - this may be expected for initial setup')
          
          # Validate catalog
          catalog = get_catalog()
          catalog_adapters = catalog.list_adapters()
          print(f'[INFO] Adapter catalog: {len(catalog_adapters)} adapters in catalog')
          
          # Validate catalog structure
          catalog_errors = catalog.validate_catalog()
          if catalog_errors:
              print('[ERROR] Catalog validation failed:')
              for error in catalog_errors:
                  print(f'  - {error}')
              sys.exit(1)
          
          # Check that policy integration works
          from src.ybis.services.policy import get_policy_provider
          policy = get_policy_provider()
          
          # Test adapter enablement (should default to False)
          test_enabled = policy.is_adapter_enabled('test_adapter')
          if test_enabled:
              print('[ERROR] Adapter enablement should default to False (opt-in)')
              sys.exit(1)
          
          print('[OK] Adapter registry validation passed')
          "

      - name: Run adapter conformance tests
        run: |
          pytest tests/adapters/ -v --tb=short
        continue-on-error: false

      - name: Validate sandbox profiles
        run: |
          python scripts/validate_sandbox_profiles.py

      - name: Build doc graph report
        run: |
          python scripts/build_doc_graph.py

      - name: Check retention policy drift
        run: |
          python -c "
          import hashlib
          from pathlib import Path
          
          policy_path = Path('docs/governance/DATA_RETENTION_POLICY.md')
          if not policy_path.exists():
              print('ERROR: DATA_RETENTION_POLICY.md not found')
              exit(1)
          
          # Calculate hash of policy file
          content = policy_path.read_text(encoding='utf-8')
          policy_hash = hashlib.sha256(content.encode()).hexdigest()
          
          # Check if policy has changed (this is a simple check)
          # In production, you might want to store expected hash in CI config
          print(f'[INFO] Retention policy hash: {policy_hash[:16]}...')
          print('[OK] Retention policy exists and is readable')
          "

