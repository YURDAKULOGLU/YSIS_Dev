services:
  # 1. The Dog (Core Agent Runtime)
  ybis-core:
    build:
      context: .. # Root of Monorepo (Relative to .YBIS_Dev/)
      dockerfile: .YBIS_Dev/Dockerfile
    container_name: ybis-core
    volumes:
      - .:/app/.YBIS_Dev # Current dir -> .YBIS_Dev
      - ../apps:/app/apps # Up one level -> apps
      - ../packages:/app/packages # Up one level -> packages
      - ../.git:/app/.git # Up one level -> .git
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - OLLAMA_HOST=host.docker.internal:11434 # Access Host Ollama
    depends_on:
      - redis
      - chromadb
    networks:
      - ybis-net

  # 2. Redis (The Nervous System - Queue/Events)
  redis:
    image: redis:7-alpine
    container_name: ybis-redis
    ports:
      - '6379:6379'
    networks:
      - ybis-net
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5

  # 3. ChromaDB (The Cortex - Memory)
  chromadb:
    image: chromadb/chroma:latest
    container_name: ybis-chromadb
    ports:
      - '8000:8000'
    networks:
      - ybis-net
    volumes:
      - chroma-data:/chroma/chroma

networks:
  ybis-net:
    driver: bridge

volumes:
  chroma-data:
