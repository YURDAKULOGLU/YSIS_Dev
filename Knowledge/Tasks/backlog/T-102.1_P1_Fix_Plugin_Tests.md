# T-102.1 (P1) Fix Plugin System Test Quality Issues

**Context:** T-102 completed successfully, but 6/11 tests are failing due to test design issues (not implementation bugs). This task fixes those test issues.

**Parent Task:** T-102 (Plugin Architecture Core)

**Goal:** Fix test quality issues so all 11 tests pass.

**Dogfooding:** This task will test our new error feedback loop in a real scenario.

---

## Current Test Status

```bash
$ python -m pytest src/agentic/core/plugin_system/tests/ -v

PASSED: 5/11
- test_calculator.py::test_add
- test_calculator.py::test_divide
- test_calculator.py::test_multiply
- test_calculator.py::test_subtract
- test_git_ops.py::test_status

FAILED: 6/11
- test_registry.py::test_register_tool
- test_registry.py::test_get_tool
- test_registry.py::test_invoke_tool
- test_protocol.py::test_tool_protocol
- test_file_ops.py::test_read_file
- test_loader.py::test_load_plugins
```

---

## Issues to Fix

### Issue 1: test_registry.py (3 failures)

**Problem:** Mock tools don't inherit from ToolProtocol, so registry correctly rejects them.

**Current code:**
```python
class MockTool:
    def execute(self, *args, **kwargs):
        return "Executed"

tool_instance = MockTool()
self.registry.register("mock_tool", tool_instance)  # Fails: TypeError
```

**Fix:**
```python
from src.agentic.core.plugin_system.protocol import ToolProtocol

class MockTool(ToolProtocol):  # Inherit from ToolProtocol
    def execute(self, *args, **kwargs):
        return "Executed"

tool_instance = MockTool()
self.registry.register("mock_tool", tool_instance)  # Should pass
```

**Files:**
- `src/agentic/core/plugin_system/tests/test_registry.py`

---

### Issue 2: test_protocol.py (1 failure)

**Problem:** Test expects TypeError but doesn't actually create a scenario that raises it.

**Current code:**
```python
def test_tool_protocol(self):
    with self.assertRaises(TypeError):
        class InvalidTool:
            pass

        tool = InvalidTool()  # This doesn't raise TypeError!
```

**Fix:** Test should verify that ToolProtocol is abstract:
```python
def test_tool_protocol(self):
    # Test 1: Cannot instantiate abstract ToolProtocol directly
    from src.agentic.core.plugin_system.protocol import ToolProtocol
    with self.assertRaises(TypeError):
        tool = ToolProtocol()  # Should fail: cannot instantiate ABC

    # Test 2: Valid tool works
    class ValidTool(ToolProtocol):
        def execute(self, *args, **kwargs):
            return "Executed"

    tool = ValidTool()
    result = tool.execute()
    self.assertEqual(result, "Executed")
```

**Files:**
- `src/agentic/core/plugin_system/tests/test_protocol.py`

---

### Issue 3: test_file_ops.py (1 failure)

**Problem:** Test uses wrong file path.

**Current code:**
```python
def test_read_file(self):
    result = self.file_ops.execute("read", "plugin_system/tests/test_protocol.py")
    # FileNotFoundError: path doesn't exist
```

**Fix:** Use correct absolute or relative path:
```python
def test_read_file(self):
    from src.agentic.core.config import PROJECT_ROOT
    test_file = PROJECT_ROOT / "src/agentic/core/plugin_system/tests/test_protocol.py"
    result = self.file_ops.execute("read", str(test_file))
    self.assertIn("TestToolProtocol", result)
```

**Files:**
- `src/agentic/core/plugin_system/tests/test_file_ops.py`

---

### Issue 4: test_loader.py (1 failure)

**Problem:** Test uses wrong directory path.

**Current code:**
```python
def test_load_plugins(self):
    self.loader.load_plugins("plugins/builtin")
    # FileNotFoundError: directory doesn't exist
```

**Fix:** Use correct absolute path:
```python
def test_load_plugins(self):
    from src.agentic.core.config import PROJECT_ROOT
    plugins_dir = PROJECT_ROOT / "src/agentic/core/plugins/builtin"
    self.loader.load_plugins(str(plugins_dir))
    self.assertIn("calculator", self.registry.tools)
    self.assertIn("file_ops", self.registry.tools)
    self.assertIn("git_ops", self.registry.tools)
```

**Files:**
- `src/agentic/core/plugin_system/tests/test_loader.py`

---

## Implementation Plan

### Step 1: Fix test_registry.py
- Update MockTool classes to inherit from ToolProtocol
- Add proper import
- Run tests to verify (3 tests should pass)

### Step 2: Fix test_protocol.py
- Rewrite test to properly test ABC behavior
- Add test for valid tool
- Run tests to verify (1 test should pass)

### Step 3: Fix test_file_ops.py
- Use PROJECT_ROOT for absolute path
- Run tests to verify (1 test should pass)

### Step 4: Fix test_loader.py
- Use PROJECT_ROOT for absolute path
- Run tests to verify (1 test should pass)

### Step 5: Verify All Tests
- Run full test suite
- Confirm all 11 tests pass
- Check coverage

---

## Success Criteria

- [ ] All 11 tests pass
- [ ] No changes to implementation code (only test files)
- [ ] Tests use correct absolute paths
- [ ] Mock tools properly inherit from ToolProtocol
- [ ] Test code follows CODE_STANDARDS (no emojis, correct imports)

---

## Expected Outcome

```bash
$ python -m pytest src/agentic/core/plugin_system/tests/ -v

test_calculator.py::test_add PASSED
test_calculator.py::test_divide PASSED
test_calculator.py::test_multiply PASSED
test_calculator.py::test_subtract PASSED
test_file_ops.py::test_read_file PASSED
test_git_ops.py::test_status PASSED
test_loader.py::test_load_plugins PASSED
test_protocol.py::test_tool_protocol PASSED
test_registry.py::test_get_tool PASSED
test_registry.py::test_invoke_tool PASSED
test_registry.py::test_register_tool PASSED

11 passed in 0.5s
```

---

## Dogfooding Notes

This task tests the new error feedback loop:
1. If Aider makes a mistake (e.g., wrong import, wrong path)
2. Sentinel will catch it in verification
3. Error will be fed back to Aider
4. Aider should fix it on retry
5. Tests should pass

**Perfect scenario to validate the feedback loop works!**

---

## Files to Modify

```
src/agentic/core/plugin_system/tests/
├── test_registry.py      # Fix MockTool inheritance
├── test_protocol.py      # Rewrite test logic
├── test_file_ops.py      # Fix file path
└── test_loader.py        # Fix directory path
```

**Total changes:** ~30 lines across 4 files

---

**Created:** 2025-12-20
**Priority:** P1 (Quality improvement, not blocking)
**Dependencies:** T-102 (completed)
**Estimated Time:** 15-20 minutes (with dogfooding)
