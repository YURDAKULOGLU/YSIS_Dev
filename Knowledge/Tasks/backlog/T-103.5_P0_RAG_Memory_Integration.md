# T-103.5 (P0) RAG Memory Integration - Context-Aware Orchestration

**Context:** RAGMemory exists but not integrated into orchestrator. System currently "blind" - no task history, no context, no learning from past executions.

**Parent:** Bootstrap Protocol Phase 1
**Goal:** Memory-aware orchestration - sistem hafÄ±zasÄ±yla Ã§alÄ±ÅŸsÄ±n

**Strategic Impact:** HIGH - Context is critical for intelligent planning

---

## Why This Matters

**Current (Blind System):**
```
User: "Fix the test imports issue"
Planner: "I'll create a plan..." (no idea similar issue was fixed in T-102.1)
Executor: "Generating code..." (no knowledge of previous solutions)
Result: Reinventing the wheel every time
```

**Target (Context-Aware):**
```
User: "Fix the test imports issue"
Planner: [Queries RAG] "Similar to T-102.1, let me use that pattern..."
Executor: [Retrieves solution] "Using proven approach from T-102.1..."
Result: Faster, smarter, learns from history
```

---

## Architecture

### Component 1: RAG-Aware SimplePlanner

**File:** `src/agentic/core/plugins/rag_aware_planner.py`

```python
from src.agentic.core.plugins.simple_planner import SimplePlanner
from src.agentic.core.plugins.rag_memory import RAGMemory
from src.agentic.core.protocols import Plan
from typing import Dict, Any

class RAGAwarePlanner(SimplePlanner):
    """SimplePlanner enhanced with RAG context retrieval"""

    def __init__(self):
        super().__init__()
        self.rag = RAGMemory()

    async def plan(self, task: str, context: Dict[str, Any]) -> Plan:
        """Generate plan with context from RAG"""

        # 1. Retrieve similar tasks from history
        similar_tasks = self.rag.query(task, limit=3)

        # 2. Build enhanced context
        enhanced_context = context.copy()
        enhanced_context['similar_tasks'] = similar_tasks
        enhanced_context['task_history'] = "\n".join(similar_tasks)

        # 3. Call parent planner with enhanced context
        plan = await super().plan(task, enhanced_context)

        # 4. Store task in RAG for future reference
        self.rag.add_text(f"TASK: {task}\nPLAN: {plan.objective}")

        return plan
```

---

### Component 2: Task History Indexer

**File:** `scripts/index_task_specs.py`

```python
"""
Index all task specifications into RAG memory
"""

from pathlib import Path
from src.agentic.core.config import PROJECT_ROOT
from src.agentic.core.plugins.rag_memory import RAGMemory

def index_task_specs():
    """Index all task specs from Knowledge/Tasks/"""

    rag = RAGMemory()
    tasks_dir = PROJECT_ROOT / "Knowledge" / "Tasks"

    # Index completed tasks
    done_dir = tasks_dir / "done"
    if done_dir.exists():
        for task_file in done_dir.glob("*.md"):
            content = task_file.read_text(encoding='utf-8')
            rag.add_text(f"FILE: {task_file.name}\n{content[:1000]}")
            print(f"[Indexed] {task_file.name}")

    # Index backlog tasks
    backlog_dir = tasks_dir / "backlog"
    if backlog_dir.exists():
        for task_file in backlog_dir.glob("*.md"):
            content = task_file.read_text(encoding='utf-8')
            rag.add_text(f"FILE: {task_file.name}\n{content[:1000]}")
            print(f"[Indexed] {task_file.name}")

    print(f"[Complete] Indexed {len(list(done_dir.glob('*.md')) + list(backlog_dir.glob('*.md')))} tasks")

if __name__ == "__main__":
    index_task_specs()
```

---

### Component 3: Test Suite

**File:** `test_rag_integration.py`

```python
"""
Test RAG integration with orchestrator
"""

import asyncio
from src.agentic.core.plugins.rag_aware_planner import RAGAwarePlanner
from src.agentic.core.plugins.rag_memory import RAGMemory

async def test_rag_retrieval():
    """Test that RAG retrieves relevant context"""

    rag = RAGMemory()

    # Add test data
    rag.add_text("TASK: Fix import paths in test files\nSOLUTION: Use src.agentic.core prefix")
    rag.add_text("TASK: Remove Aider artifacts from code\nSOLUTION: Enhanced Sentinel detection")

    # Query
    results = rag.query("How to fix test imports?", limit=2)

    assert len(results) > 0, "RAG should return results"
    assert "import" in results[0].lower(), "Results should be relevant"

    print("[PASS] RAG retrieval working")

async def test_rag_aware_planner():
    """Test RAG-aware planner"""

    planner = RAGAwarePlanner()

    # Plan a task similar to previous ones
    plan = await planner.plan(
        task="Fix test file import errors",
        context={"repo": "YBIS_Dev"}
    )

    assert plan.objective, "Plan should have objective"
    assert len(plan.steps) > 0, "Plan should have steps"

    print("[PASS] RAG-aware planner working")
    print(f"  Objective: {plan.objective}")
    print(f"  Steps: {len(plan.steps)}")

async def test_end_to_end_with_rag():
    """Test full orchestrator with RAG"""

    from src.agentic.core.graphs.orchestrator_graph import OrchestratorGraph
    from src.agentic.core.plugins.aider_executor_enhanced import AiderExecutorEnhanced
    from src.agentic.core.plugins.sentinel_enhanced import SentinelVerifierEnhanced
    from datetime import datetime

    # Create orchestrator with RAG-aware planner
    planner = RAGAwarePlanner()
    executor = AiderExecutorEnhanced()
    verifier = SentinelVerifierEnhanced()

    orchestrator = OrchestratorGraph(planner, executor, verifier)

    # Simple task state
    task_state = {
        "task_id": "RAG-TEST",
        "task_description": "Create a simple function that adds two numbers",
        "phase": "init",
        "plan": None,
        "code_result": None,
        "verification": None,
        "retry_count": 0,
        "max_retries": 1,
        "error": None,
        "started_at": datetime.now(),
        "completed_at": None,
        "artifacts_path": ".sandbox_hybrid/RAG-TEST",
        "error_history": [],
        "failed_at": None
    }

    # This should use RAG context during planning
    result = await orchestrator.ainvoke(task_state)

    assert result['phase'] in ['verify', 'failed'], "Task should complete"

    print("[PASS] End-to-end with RAG")

if __name__ == "__main__":
    asyncio.run(test_rag_retrieval())
    asyncio.run(test_rag_aware_planner())
    asyncio.run(test_end_to_end_with_rag())
```

---

### Component 4: Integration Wrapper

**File:** `run_with_rag.py`

```python
"""
Run orchestrator with RAG integration
"""

import asyncio
import sys
from pathlib import Path
from datetime import datetime
from src.agentic.core.config import PROJECT_ROOT
from src.agentic.core.graphs.orchestrator_graph import OrchestratorGraph
from src.agentic.core.plugins.rag_aware_planner import RAGAwarePlanner
from src.agentic.core.plugins.aider_executor_enhanced import AiderExecutorEnhanced
from src.agentic.core.plugins.sentinel_enhanced import SentinelVerifierEnhanced
from src.agentic.core.protocols import TaskState

async def main(task_id: str):
    """Run task with RAG-aware orchestration"""

    # Load task spec
    task_file = PROJECT_ROOT / "Knowledge" / "Tasks" / "backlog" / f"{task_id}.md"
    if not task_file.exists():
        print(f"[ERROR] Task file not found: {task_file}")
        return

    task_spec = task_file.read_text(encoding='utf-8')

    print("="*80)
    print(f"Running {task_id} with RAG Integration")
    print("="*80)
    print()

    # Create orchestrator with RAG
    planner = RAGAwarePlanner()  # RAG-aware!
    executor = AiderExecutorEnhanced()
    verifier = SentinelVerifierEnhanced()

    orchestrator = OrchestratorGraph(planner, executor, verifier)

    # Create task state
    task_state: TaskState = {
        "task_id": task_id,
        "task_description": task_spec,
        "phase": "init",
        "plan": None,
        "code_result": None,
        "verification": None,
        "retry_count": 0,
        "max_retries": 3,
        "error": None,
        "started_at": datetime.now(),
        "completed_at": None,
        "artifacts_path": str(PROJECT_ROOT / ".sandbox_hybrid" / task_id),
        "error_history": [],
        "failed_at": None
    }

    # Execute with RAG context
    result = await orchestrator.ainvoke(task_state)

    # Report
    print()
    print("="*80)
    print("EXECUTION COMPLETE")
    print("="*80)
    print(f"Phase: {result['phase']}")
    print(f"Retries: {result['retry_count']}")

    if result.get('verification'):
        v = result['verification']
        print(f"Tests: {'PASS' if v.tests_passed else 'FAIL'}")
        print(f"Lint: {'PASS' if v.lint_passed else 'FAIL'}")

if __name__ == "__main__":
    task_id = sys.argv[1] if len(sys.argv) > 1 else "T-103.5_P0_RAG_Memory_Integration"
    asyncio.run(main(task_id))
```

---

## Implementation Plan

### Step 1: Create RAGAwarePlanner
1. Extend SimplePlanner
2. Add RAG query before planning
3. Inject context into prompt
4. Store task after planning

### Step 2: Index Existing Tasks
1. Run `scripts/index_task_specs.py`
2. Verify ChromaDB populated
3. Test retrieval accuracy

### Step 3: Integration Tests
1. Test RAG retrieval standalone
2. Test RAG-aware planner
3. Test end-to-end orchestration

### Step 4: Production Integration
1. Update orchestrator to use RAGAwarePlanner by default
2. Auto-index new tasks after completion
3. Document usage

---

## Success Criteria (Gate)

- [ ] RAGAwarePlanner created and working
- [ ] Task specs indexed in ChromaDB (all tasks in Knowledge/Tasks/)
- [ ] Context retrieval returns relevant results (>70% accuracy)
- [ ] End-to-end test passes with RAG
- [ ] Smoke test: Query "import errors" returns T-102.1
- [ ] Zero emoji violations
- [ ] Zero import violations
- [ ] Zero artifact violations

---

## Files to Create

```
src/agentic/core/plugins/
â””â”€â”€ rag_aware_planner.py (~80 lines)

scripts/
â””â”€â”€ index_task_specs.py (~40 lines)

test_rag_integration.py (~100 lines)
run_with_rag.py (~80 lines)
```

**Total:** ~300 lines

---

## EVIDENCE/ Required

```
Knowledge/Bootstrap/T-103.5/EVIDENCE/
â”œâ”€â”€ rag_init.log (ChromaDB initialization)
â”œâ”€â”€ index_tasks.log (indexing results - X tasks indexed)
â”œâ”€â”€ query_test.log (retrieval accuracy)
â”œâ”€â”€ planner_test.log (RAG-aware planner output)
â””â”€â”€ e2e_with_rag.log (full orchestration)
```

---

## DECISIONS.json

```json
{
  "embedding_model": "all-MiniLM-L6-v2",
  "vector_db": "ChromaDB",
  "persist_path": "Knowledge/LocalDB/chroma_db",
  "index_targets": [
    "Knowledge/Tasks/done/*.md",
    "Knowledge/Tasks/backlog/*.md"
  ],
  "retrieval_limit": 3,
  "similarity_threshold": 0.7,
  "auto_index_on_completion": true
}
```

---

## Expected Outcome

**Before RAG:**
```
[SimplePlanner] Planning task...
[Planner] No context available
[Planner] Creating plan from scratch
```

**After RAG:**
```
[RAGAwarePlanner] Planning task...
[RAG] Retrieving similar tasks...
[RAG] Found 3 relevant tasks: T-102.1, T-102, T-100
[Planner] Using context from previous solutions
[Planner] Plan informed by history
```

---

## Dogfooding Notes

This task will be executed BY THE SYSTEM using OrchestratorGraph:
1. RAGAwarePlanner will be created by Aider
2. Tests will be generated
3. Integration will be verified by Sentinel
4. If errors occur â†’ Feedback loop corrects

**Meta:** System is adding memory to itself! ðŸ§ 

---

**Created:** 2025-12-20
**Priority:** P0 (Foundation for intelligence)
**Dependencies:** RAGMemory (already exists âœ“)
**Estimated Time:** 1 day (with dogfooding)
**Bootstrap Phase:** 1 of 4
