# Flows System - Architecture Design

**Generated by:** @Research (Gemini CLI)
**Date:** 2025-12-01
**Related Task:** T-007

## 1. Overview

This document outlines the architecture for a rule-based automation system named "Flows". The system is designed around the core logic of **"Observe Data -> Classify -> Act on Classification"** and is built primarily on the Supabase platform. It is intended to guide the `@ClaudeCode` agent in the implementation process.

## 2. Core Architecture

The system is event-driven and leverages a combination of Supabase's features to create a powerful and flexible automation engine.

*   **1. Observe Data (Triggering):**
    *   **Mechanism:** PostgreSQL Triggers and Supabase Realtime.
    *   **Process:** A trigger will be placed on a target table (e.g., `tasks`). When a row is inserted or updated, the trigger fires. This can also be observed by clients subscribed to Supabase Realtime. For time-based events, **Supabase Cron** will be used.

*   **2. Classify (Rule Evaluation):**
    *   **Mechanism:** Supabase Edge Function.
    *   **Process:** The trigger will invoke a central "Flow Engine" Edge Function. This function will receive the data from the trigger, find the relevant "Flow" and its associated "Rules" from the database, and evaluate the data against these rules to determine if the conditions for an action are met.

*   **3. Act on Classification (Action Execution):**
    *   **Mechanism:** Supabase Edge Function.
    *   **Process:** If the rules are met, the Edge Function will execute the defined "Action". This could involve:
        *   Making a database change (e.g., updating a status).
        *   Calling an external API (e.g., sending a Slack notification).
        *   Invoking another Supabase Function.

## 3. Proposed Data Model

The following data model will be used to define and manage the flows.

**`flows` Table**
*   `flow_id` (PK)
*   `name` (String): A human-readable name for the flow (e.g., "Notify PM on High-Priority Task").
*   `trigger_table` (String): The name of the table that triggers this flow (e.g., "tasks").
*   `trigger_event` (Enum: 'INSERT', 'UPDATE'): The database event that triggers the flow.
*   `is_enabled` (Boolean): A flag to enable or disable the flow.

**`rules` Table**
*   `rule_id` (PK)
*   `flow_id` (FK to `flows`): The flow this rule belongs to.
*   `field` (String): The field in the `trigger_table` to evaluate (e.g., "priority").
*   `operator` (Enum: '=', '!=', '>', '<', 'CONTAINS', etc.): The comparison operator.
*   `value` (String): The value to compare against (e.g., "High").

**`actions` Table**
*   `action_id` (PK)
*   `flow_id` (FK to `flows`): The flow this action belongs to.
*   `type` (Enum: 'DB_UPDATE', 'API_CALL', 'FUNCTION_CALL'): The type of action to perform.
*   `config` (JSONB): A flexible field to store the configuration for the action.
    *   For `DB_UPDATE`: `{"table": "tasks", "field": "status", "value": "In Progress"}`
    *   For `API_CALL`: `{"url": "https://hooks.slack.com/...", "method": "POST", "body": "..."}`
    *   For `FUNCTION_CALL`: `{"function_name": "send-email", "params": {"to": "..."}}`

**`flow_executions` Table**
*   `execution_id` (PK)
*   `flow_id` (FK to `flows`): The flow that was executed.
*   `status` (Enum: 'SUCCESS', 'FAILURE'): The execution status.
*   `triggered_at` (Timestamp): When the flow was triggered.
*   `log` (Text): Detailed logs of the execution for debugging.

## 4. Implementation Steps for @ClaudeCode

1.  **Database Setup:**
    *   Create a new migration file in `packages/database` to add the `flows`, `rules`, `actions`, and `flow_executions` tables.
2.  **Flow Engine Edge Function:**
    *   Create a new Supabase Edge Function named `flow-engine`.
    *   This function will be the entry point for all flow triggers.
    *   It should:
        1.  Receive the payload (the new or updated row).
        2.  Query the `flows`, `rules`, and `actions` tables to find matching flows.
        3.  Evaluate the rules.
        4.  If the rules pass, execute the defined actions.
        5.  Log the execution to the `flow_executions` table.
3.  **Database Trigger Function:**
    *   Create a PostgreSQL function that calls the `flow-engine` Edge Function using `net.http_post`.
4.  **Database Trigger Creation:**
    *   Create a trigger on the desired table (e.g., `tasks`) that calls the trigger function on `INSERT` or `UPDATE`.
5.  **Frontend UI (Future Task):**
    *   (A separate task will be created for this) A UI will be needed to allow users to create, manage, and monitor their flows.

This architecture provides a robust and scalable foundation for the "Flows" system, with Supabase at its core.
